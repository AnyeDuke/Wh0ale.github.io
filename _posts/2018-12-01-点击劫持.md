---
layout:     post
title:      白盒测试
date:       2018-12-01
author:     Wh0ale
header-img: img/wallhaven-703812.png
catalog: true
tags:
    - 点击劫持
    - JSRC
---

# 第106期【web漏洞挖掘之点击劫持漏洞】

## 0x01什么是点击劫持

![img](https://mmbiz.qpic.cn/mmbiz_png/Z9MuUwaeeGLe7RjWqSbNUqpt0GLIgKsKpHiaJ8a0RDAvszbSH169PnrxibvJ38ZSzYWxojNBxm7R5A8zBwyZ69YA/640?wx_fmt=png&tp=webp&wxfrom=5&wx_lazy=1&wx_co=1)

点击劫持---clickjacking，也叫UI-覆盖攻击（UI redress attack）。

最早是在2008年，由互联网安全专家罗伯特·汉森和耶利米·格劳斯曼首创。

百度百科上对其的定义如下：

它是通过覆盖不可见的框架误导受害者点击。

虽然受害者点击的是他所看到的网页，但其实他所点击的是被黑客精心构建的另一个置于原网页上面的透明页面。

这种攻击利用了HTML中<iframe>标签的透明属性

##　0x02点击劫持攻击的原理

点击劫持实际上是一种视觉上的欺骗手段，攻击者通过利用一个透明的、不可见的iframe，覆盖在某网页上，然后诱导用户在该网页上进行点击等操作，而此时用户在不知情的情况下点击了透明的iframe页面。

通过调整iframe页面的位置，可以诱使用户恰好点击在iframe页面的一些功能性按钮上。

如使用css调整图片大小位置，通过设置opacity参数调整元素透明度等；目的都是让用户就无法看到含恶意代码的目标网页。

## 0x03点击劫持攻击的挖掘思路

通过分析点击劫持攻击的原理，我们可以获知：当应用允许iframe标签进行页面嵌套时，则能基本断定网站存在点击劫持攻击漏洞

1、简单的就是用iframe嵌入目标网站试试，若成功，则说明漏洞存在。

![img](https://mmbiz.qpic.cn/mmbiz_png/Z9MuUwaeeGLe7RjWqSbNUqpt0GLIgKsKbGHS1fA7WQ91icHlkwlDFh4ib2UVnvnQaGYnibR7cKMcT9jOiaiaSMUG2tA/640?wx_fmt=png&tp=webp&wxfrom=5&wx_lazy=1&wx_co=1)

2、通过判断目标的HTTP响应头是否设置好了X-Frame-Options字段，是否有JavaScript的Frame Busting机制；常见的我们使用WVS扫描网站时会提示如下：

![img](https://mmbiz.qpic.cn/mmbiz_png/Z9MuUwaeeGLe7RjWqSbNUqpt0GLIgKsKYyJ1ddYSLxEiaOCPNCFXbT6IZzt6hHy73EwLHglE9NhkF3wOanIXkXw/640?wx_fmt=png&tp=webp&wxfrom=5&wx_lazy=1&wx_co=1)这就是通过判断是否存在X-Frame-Options响应头来处理

3、其他辅助工具进行clickjacking漏洞探测的时候，也都基本上基于以上情况进行处理，比如：

```
   try:
       if"http"notin url: url = "http://" + url
       data = urlopen(url)
       headers = data.info()
       if not"X-Frame-Options"in headers: returnTrue
   except: returnFalse
```

```
        for i in page.headers:
            if i.lower() instr(headers).lower():
                pass
            elif i == "server":
                structure= str(i)+" : "+str(page.headers[i])
                headersfound.append(structure)
                structure= "Server:"+boldwhite+str(page.headers[i])+reset
                interesting.append(structure)
            elif i == "x-powered-by":
                structure= str(i)+" : "+str(page.headers[i])
                headersfound.append(structure)
                structure= "Poweredby: "+boldwhite+str(page.headers[i])+reset
                interesting.append(structure)
            elif i == "x-frame-options":
                cj= 1
                pass
            else:
                structure= str(i)+" : "+str(page.headers[i])
                headersfound.append(structure)
        if cj == 0:
            caution.append("[!]"+red+" X-Frame-Options header Missing\n"+reset+"[!] "+red+"Page might be vulnerable to "+boldred+"Click Jacking\n"+reset+"[!] "+boldred+page.geturl()+reset+"\n[i] About ClickJacking: [ "+green+"https://www.owasp.org/index.php/Clickjacking"+reset+" ]") 
```

https://github.com/D4Vinci/Clickjacking-Tester

https://github.com/LTF1633242320/D-TECT      

## 0x04点击劫持攻击的案例分析

比较知名的点击劫持案例，包括Facebook 的‘likejacking’攻击、Adobe Flash Player 网站漏洞、Twitter 的 Don’t click 攻击、谷歌账户点击劫持攻击等。

案例1、Flash点击劫持

最为经典的案例是攻击者通过flash构造出点击劫持，最终控制用户电脑摄像头事件;

首先，攻击者构造一个flash小游戏，并贴心逼真地显示了游戏得分以及游戏耗时，诱导用户试玩；在试玩过程中引导用户点击不停变换位置的“click”按钮，

而其实在游戏界面中隐藏了一个看不见的iframe

![img](https://mmbiz.qpic.cn/mmbiz_png/Z9MuUwaeeGLe7RjWqSbNUqpt0GLIgKsKJ1L7xC1MlbeaYRVAcwfZnfRibxJlWWEGicJ4NX00ou5FmXv5ZnkkEM7A/640?wx_fmt=png&tp=webp&wxfrom=5&wx_lazy=1&wx_co=1)

攻击通过诱导用户使用鼠标点击看似随意的位置，来完成较为复杂的操作。

![img](https://mmbiz.qpic.cn/mmbiz_png/Z9MuUwaeeGLe7RjWqSbNUqpt0GLIgKsKm79L2ibEkVbe3eG6kVT11LoTmuXuSQn1EYzCzhuZ2kmrMrvXGMicKibzg/640?wx_fmt=png&tp=webp&wxfrom=5&wx_lazy=1&wx_co=1)

![img](https://mmbiz.qpic.cn/mmbiz_png/Z9MuUwaeeGLe7RjWqSbNUqpt0GLIgKsK7Oh5Om2zqib8qFm66uk8GpffrlhpxXtaXPzqFWJHDLnXf0v4fpddyDA/640?wx_fmt=png&tp=webp&wxfrom=5&wx_lazy=1&wx_co=1)

并最终开启了用户的摄像头

![img](https://mmbiz.qpic.cn/mmbiz_png/Z9MuUwaeeGLe7RjWqSbNUqpt0GLIgKsKur1euiaibWrTwuib4zaK1jyS5XLvZsV4ImmwMZFS1kbwhD6Bo9TrPRByA/640?wx_fmt=png&tp=webp&wxfrom=5&wx_lazy=1&wx_co=1)

案例2、某浪博客关注点击劫持

ID：wooyun-2015-0106173

在新浪博客的“加关注”处：

![img](https://mmbiz.qpic.cn/mmbiz_png/Z9MuUwaeeGLe7RjWqSbNUqpt0GLIgKsKhGa43r2oLFRF8icDI5ic69nm4z3WVHf1MbGeRwfveoSpf3GDwRib7mWibg/640?wx_fmt=png&tp=webp&wxfrom=5&wx_lazy=1&wx_co=1)

通过简单构造的html页面，如下，

![img](https://mmbiz.qpic.cn/mmbiz_png/Z9MuUwaeeGLe7RjWqSbNUqpt0GLIgKsKXDr7bcvbxfVtwG0vCtrtzl6Mqj6tt5OCC2eEwR01xmq9HJia3B5bubw/640?wx_fmt=png&tp=webp&wxfrom=5&wx_lazy=1&wx_co=1)

![img](https://mmbiz.qpic.cn/mmbiz_png/Z9MuUwaeeGLe7RjWqSbNUqpt0GLIgKsKwEKf8oXvfibHTNVCqMoEb2ib68hOOWuicOXMyrbDEn5nujyN7kfianUiaHQ/640?wx_fmt=png&tp=webp&wxfrom=5&wx_lazy=1&wx_co=1)

从而进行博客关注数量的刷新

![img](https://mmbiz.qpic.cn/mmbiz_png/Z9MuUwaeeGLe7RjWqSbNUqpt0GLIgKsKdyXnIlrRNkAIFIwl1RJY9SwmtsLvMcXKIPF2ibIoKl8iaHXdCDTNVuDA/640?wx_fmt=png&tp=webp&wxfrom=5&wx_lazy=1&wx_co=1)

当然可以再对html页面进行精心美化调整，从而大面积进行点击劫持攻击的实施。

附：

github上的一个模拟demo: 

https://github.com/thomaspatzke/Clickjacking-Exploit

4.点击劫持攻击其他使用场景

钓鱼，欺骗，信息盗取等。

（1）    结合Self-XSS

（2）    结合反射XSS

（3）    结合CSRF

## 0x05点击劫持攻击防御方法

服务器端

Frame busting

通过js代码禁止iframe的嵌套，如判断顶层窗口跳转：

```
if (top.location != self.location) {
   top.location = self.location;
}
```

常见Frame busting：

```
if (top != self)
if (top.location != self.location)
if (top.location != location)
if (parent.frames.length > 0)
if (window != top)
if (window.top !== window.self)
if (window.self != window.top)
if (parent && parent != window)
if (parent && parent.frames && parent.frames.length > 0)
if ((self.parent && !(self.parent === self)) && (self.parent.frames.length != 0))
+
top.location = self.location
top.location.href = document.location.href
top.location.href = self.location.href
top.location.replace(self.location)
top.location.href = window.location.href
top.location.replace(document.location)
top.location.href = window.location.href
top.location.href = "URL"
document.write()
top.location = location
top.location.replace(document.location)
top.location.replace(URL)
top.location.href = document.location
top.location.replace(window.location.href)
top.location.href = location.href
self.parent.location = document.location
parent.location.href = self.document.location
top.location.href = self.location
top.location = window.location
top.location.replace(window.location.pathname)
window.top.location = window.self.location
setTimeout(function () { document.body.innerHTML =; }, 1);
window.self.onload = function (evt) {document.body.innerHTML =; }
varurl = window.location.href; top.location.replace(url)
```

但frame busting存在被绕过的可能，如多层iframe嵌套等；在HTML 5中iframe的sandbox属性、IE中iframe的security属性等，都可以限制iframe页面中的脚本执行，从而可以使得frame busting失效

设置<iframe>属性：

（1）sandbox

<iframesrc="xxx"scrolling="no"sandbox="">

![img](https://mmbiz.qpic.cn/mmbiz_png/Z9MuUwaeeGLe7RjWqSbNUqpt0GLIgKsKmCme5jLYHKicibUwhia1ibp5pbhxujKoMvVULR8IpxxvS4LKqbVib2QibkxQ/640?wx_fmt=png&tp=webp&wxfrom=5&wx_lazy=1&wx_co=1)

（2）security

<iframesrc="xxx"scrolling="no"security="restricted">

security设置为restricted后，frame中的脚本将不能执行；但仅限于IE

由于无法执行js脚本，则通过JS来判断顶层跳转将失败

使用X-Frame-Options属性

（1）IIS配置

在web站点的web.config中配置。

```
<system.webServer>
            ......
  <httpProtocol>
                <customHeaders>
                    <addname="X-Frame-Options"value="DENY"/>
                </customHeaders>
            </httpProtocol>
            ......
</system.webServer>
```

（2）apache配置

A).开启mod_headers.so，即在httpd.conf中去掉“LoadModule headers_modulemodules/mod_headers.so”前的#

B).修改httpd.conf，添加下面内容。

```Header always append X-Frame-OptionsDENY
Header always append X-Frame-Options DENY
```

修改完如下:

```
<IfModule headers_module>
RequestHeader unset DNT env=bad_DNT
Header always append X-Frame-OptionsDENY
</IfModule>
```

如果同一台apache服务器上有多个站点，只想针对其中一个站点进行配置，可以修改.htaccess文件，添加如下内容：

```
Header append X-FRAME-OPTIONS"DENY"
```

（3）nginx配置

修改nginx.conf,在server下添加下面内容。

add_header X-Frame-Options"DENY";

添加完成如下：

```
server{
       listen80;
       server_namewww.dqiang.com;
       indexindex.html;
       add_headerX-Frame-Options"DENY";
   }
```



客户端

及时升级浏览器

最新版浏览器通常具备更好更多的安全机制保护客户的信息安全，及时升级更新浏览器，可从一定程度上进行漏洞攻击的有效防范

安装相应浏览器扩展插件

通过安装浏览器的扩展插件，达到对潜在威胁进行阻止及警告，及时判断页面中的不安全因素；如Firefox:安装插件NoScript，在选项中设置禁止<iframe>

![img](https://mmbiz.qpic.cn/mmbiz_png/Z9MuUwaeeGLe7RjWqSbNUqpt0GLIgKsKsicuHmkewRNOpSBsAg12egSZ5dc3K2Iu3If1WWZq6dp8k6P8Hmua3MA/640?wx_fmt=png&tp=webp&wxfrom=5&wx_lazy=1&wx_co=1)

**1.** **怎么配合反射型xss使得变成存储型xss的效果?**

**讲师:**

要配合反射XSS形成存储XSS的效果，首先得构造一个劫持页面，将反射型XSS包含其中，诱使用户在不知情情况下进行点击，从而到达存储XSS的效果

**2.** **点击劫持必须要目标网站也有一个可以点击的地方吗?**

**讲师:**

既然称为点击劫持，是需要目标网站有存在点击的地方，当然也有可能通过拖拽动作进行劫持

**3.** 如果不能插入iframe是不是就不能实现点击劫持了?

**讲师:**

如果无法插入iframe，则不能实现点击劫持



附：POC生成工具

https://github.com/enddo/CJExploiter

![img](https://mmbiz.qpic.cn/mmbiz_png/Z9MuUwaeeGLe7RjWqSbNUqpt0GLIgKsKY4evqKCu85p1sIp20ED9tRVRg3vyuZ6RNu7L3YiajGTIrSNqknbMGBA/640?wx_fmt=png&tp=webp&wxfrom=5&wx_lazy=1&wx_co=1)

https://github.com/sensepost/jack

![img](https://mmbiz.qpic.cn/mmbiz_png/Z9MuUwaeeGLe7RjWqSbNUqpt0GLIgKsK1HqW5vOicX7QgzicJxtNh0YECO2AEWKoh4VtMRpBupSphhxbO0whradQ/640?wx_fmt=png&tp=webp&wxfrom=5&wx_lazy=1&wx_co=1)

https://github.com/samyk/quickjack 

![img](https://mmbiz.qpic.cn/mmbiz_png/Z9MuUwaeeGLe7RjWqSbNUqpt0GLIgKsKu5egF7PaccwzsD6OLdkNomEsu5Xv9H5FmZwGavxGOgZjMTPjHDrw2w/640?wx_fmt=png&tp=webp&wxfrom=5&wx_lazy=1&wx_co=1)

转载自JSRC